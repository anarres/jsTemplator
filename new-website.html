<html>
<head>
<LINK href="style.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="betterSplit.js"></script>
<script type="text/javascript" src="getElementsByClassNameDiaz.js"></script>

<script>

var fooRegEx = /<!--START[\s\S]*?END-->/gm;
var fooRegEx2 = /<!--START[\s\S]*?-->/gm;

/**
 * Transform text into a URL slug: spaces turned into dashes, remove non alnum
 * @param string text
 * By milesjonson, http://milesj.me/snippets/javascript/slugify
 */
function slugify(text) {
	text = text.replace(/[^-a-zA-Z0-9,&\s]+/ig, '');
	text = text.replace(/-/gi, "_");
	text = text.replace(/\s/gi, "-");
	return text;
}

function removeItemFromArray(array, index) {
    var maxfoo = array.length - 1;
    for( var i=index; i<maxfoo; i++ ) {
        array[i] = array[i+1];
    }
    array.pop();
    return array;
}

// Class 'replacement' definition
function replacement(shortName, niceName) {
    this.shortName = shortName;
    this.niceName = niceName;
    this.startString = "<!--START" + shortName + "-->";
    this.endString = "<!--" + shortName + "END-->";

    this.toString = function () {
      return 'replacement object: ' + this.niceName;
    };
    this.userInputHTML = function () {
        var html = "<p>" + this.niceName + ":<input type='text' class='userInput' id='" + this.shortName + "' name='" + this.shortName + "'></p>";
        return html;
    };
}

function getStartString(myName) {    
    return "<!--START" + myName + "-->";
}
function getEndString(myName) {
    return "<!--" + myName + "END-->";
}

// Class 'page' definition - both arguments are integers
function page(menu, menuRank) {
    this.menu = menu;
    this.menuRank = menuRank;

    // Page title
    var pageTitleShortName = "page" + menu + "_" + menuRank;
    var pageTitleNiceName = "page " + menuRank + " of menu " + menu + " title";
    this.pageTitle = new replacement(pageTitleShortName, pageTitleNiceName);

    // Page content
    var pageContentShortName = "page" + menu + "_" + menuRank;
    var pageContentNiceName = "page " + menuRank + " of menu " + menu + " content";
    this.pageContent = new replacement(pageContentShortName, pageContentNiceName);

    this.toString = function () {
      return 'page object';
    };

    this.userInputHTML = function () {
        var html = "<div class='pageInput'>";
        html += this.pageTitle.userInputHTML();
        html += this.pageContent.userInputHTML();
        html += "<p>This page belongs to menu: " + 
            this.menu + " and has rank: " + this.menuRank + 
            ". <span class='delete' onclick='removePage(" + 
            this.menu + ", " + this.menuRank + ")'>delete this page</span></p></div>";
        return html;
    };
}

function removePage(menu, menuRank) {
    var pagesArray = new Array();
    for( var i=0; i<templateObj.pages.length; i++ ) {

        // Leave out the page we're removing
        if ( !(templateObj.pages[i].menu == menu && templateObj.pages[i].menuRank == menuRank) ) {

            // If a page is in the same menu and has a higher menuRank than the one
            // that is removed, subtract 1 from its menuRank
            if( templateObj.pages[i].menu == menu && templateObj.pages[i].menuRank > menuRank ) {
                templateObj.pages[i].menuRank -= 1;
            }
            pagesArray.push(templateObj.pages[i]);
        }
    }
    templateObj.pages = pagesArray;
    templateChosen();
}

// Class 'template' definition
function template(templateName, html, replacementsArray, pagesArray, maxMenus) {
    this.templateName = templateName;
    this.html = html;
    this.replacements = [];   // Array of replacement objects
    this.replacements = replacementsArray;
    this.pages = [];   // Array of replacement objects
    this.pages = pagesArray;
    this.maxMenus = maxMenus;   // Number of menus: 1,2,3...

    this.toString = function () {
      return 'template object: ' + this.templateName;
    };

    this.getReplacements = function () {
        var output = new Array();
        for( var i=0; i< this.replacements.length; i++ ) {
            output.push( this.replacements[i] );
        }
        for( var j=0; j<this.pages.length; j++ ) {
            output.push( this.pages[j].pageTitle );
            output.push( this.pages[j].pageContent );
        }
        return output;
    };
}

// An instance of class 'template'
var basicTemplate = new template('basicTemplate',
    "<html><h1><!--STARTwebsiteTitle--><!--websiteTitleEND--></h1> <!--STARTmenu0--><!--menu0END-->  <h2><!--STARTpageContent--> <!--pageContentEND--><p><!--STARTfooter--> <!--footerEND--></p></html>",
    new Array(
        new replacement('websiteTitle', 'Website title'),
        new replacement('footer', 'Footer')
    ),
    new Array(
        new page(0,0)
    ),
    1
);

// GLOBAL VAR!!! (for now)
var templateObj = basicTemplate;

/* Takes template, removes the section from startString to endString' +  
inclusive, replaces this with insertText, and returns the result */
function replaceFoo(template, startString, endString, insertText) {
    var stringArray = template.split(startString);
    if( stringArray.length == 2 ) { 
        var outputString = stringArray[0];
        outputString += startString;
        outputString += insertText;
        outputString += endString;
        var stringArray2 = stringArray[1].split(endString);
        if( stringArray2.length != 2 ) { alert('DEBUG 2'); } // DEBUG 2
        outputString += stringArray2[1];
        return outputString;
    }
    else {
        return template;
    }
}

/* Allows a 2D array to be treated like a Python dictionary 
myArray looks like this: 
[ ['species','cat'], ['name','Fluffy'], ['age','7 years'] ] */
function giveNameGetValue(myArray, myName) {
    for( var i=0; i<myArray.length; i++ ) {
        if( myArray[i][0] == myName ) {
            return myArray[i][1];
        }
    }
    return false;
}

function getStartString(myName) {    
    return "<!--START" + myName + "-->";
}
function getEndString(myName) {
    return "<!--" + myName + "END-->";
}

function templateToHTML(template, repsArray) {
    for ( var i=0; i<repsArray.length; i++ ) {
        template = replaceFoo(template, getStartString( repsArray[i][0] ), getEndString( repsArray[i][0] ), repsArray[i][1] );
    }
    return template;
}

function htmltotemplate(html) {
    var template = "";

    // Split html into an array of substrings
    var myArray = splitStringKeepDelimiters(html, fooRegEx);

    // For each substring in the array
    for(var i=0; i<myArray.length; i++) {

        // Check it it's a templatey bit
        if( myArray[i].slice(0,9) == "<!--START" ) {

            // If yes, get the name-thing
            var myMatchArray = myArray[i].match(fooRegEx2);
            var myMatch = myMatchArray[0];
            var myName = myMatch.slice(9,-3);

            if( myName.slice(0,4) == "menu" ) {
                alert('myName: ' + myName);
            }

            // Add the reconstructed string:
            template += "<!--START";
            template += myName;
            template += "--><!--";
            template += myName;
            template += "END-->";
        }
        // It's not a templatey bit - just add it straight in
        else {
            template += myArray[i];
        }
    }
    return template;
}

function htmlToReps(html) {
    var output = new Array();

    // Get array of things like this: <!--STARTsomeName-->Some other stuff<!--someNameEND-->
    var myArray = splitStringKeepDelimiters(html, fooRegEx, "delimitersOnly");

    // For each item in the array
    for(var i=0; i<myArray.length; i++) {

        // Extract someName
        var myMatchArray = myArray[i].match(fooRegEx2);
        var myMatch = myMatchArray[0];
        var someName = myMatch.slice(9,-3);
        output.push(someName);
    }
    return output;
}

function processReps(reps) {
    var repObjs = new Array();
    for( var i=0; i<reps.length; i++ ) {

        if( reps[i].slice(0,4) != "menu" ) {
            repObjs.push( new replacement(reps[i], reps[i]) );
        }
        else {
            var menuNum = reps[i].slice(4);
            var pageTitles = new Array('Home', 'About');
            for( var i=0; i<pageTitles.length; i++ ) {
                var pageObj = new page(menuNum, i);
                repObjs.push( pageObj.pageTitle );
                repObjs.push( pageObj.pageContent );
            }
        }
    }
    return repObjs;
}

function templateChosen() {
    document.getElementById('newPage').style.visibility = "visible";
    document.getElementById('newMenu').style.visibility = "visible";
    var reps = htmlToReps(basicTemplate.html);    
    var repObjs = processReps(reps);
    var myDiv = document.getElementById('dynamic');
    for( var j=0; j<repObjs.length; j++ ) {
        myDiv.innerHTML += repObjs[j].userInputHTML();
    }
}

function makeMenu(menuID, pageTitles) {
    var output = "<div id='" + menuID + "'>";
    for( var i=0; i<pageTitles.length; i++ ) {
        output += "<li><a href='";
        output += slugify(pageTitles[i]) + ".html";
        output += "'>";
        output += pageTitles[i];
        output += "</a></li>";
    }
    output += "</div>";
    return output;
}

function getPageTitles(replacements, menuNum) {
    var pageTitles = new Array();
    var prefix = "page" + menuNum;
    var suffix  = "Title";
    for( var i=0; i<replacements.length; i++ ) {
        if( replacements[i][0].slice(0,5) == prefix && replacements[i][0].slice(7) == suffix  ) {
            pageTitles.push( replacements[i][1] );
        }
    }
    return pageTitles;
}
////////////////////////////////////////////////////////////////////////////////////////////////////////
function getPageReplacements(menu, menuRank, replacements) {
    var pageReplacements = new Array();
    var myString = "" + menu + "_" + menuRank;
    var pageX_XTitle = "page" + myString + "Title";
    var pageX_XContent = "page" + myString + "Content";

    // This is an array of arrays of page titles
    var menusIndices = new Array();

    // Get the number of menus
    for( var i=0; i<replacements.length; i++ ) {
        if( replacements[i][0].slice(0,4) == "page"  ) {
            alert(replacements[i][0].slice(4,5));




//////////////////////////
            numMenus++;
        }
    }
    alert(numMenus);
    // Make an array of arrays to hold the pageTitles
    for( var i=0; i<numMenus; i++ ) {
        menus.push( new Array() );
    }
    
    for( var i=0; i<replacements.length; i++ ) {
        if( replacements[i][0].slice(0,4) == "page" ) {

            // Add it to the relevant menu if it is the title
            if( replacements[i][0].slice(7) == "Title" ) {
                var menuNum = parseInt( replacements[i][0].slice(4,5) );
                var pageNum = parseInt( replacements[i][0].slice(6,7) );
                menus[menuNum][pageNum] = replacements[i][1];
            }
            if( replacements[i][0] == pageX_XTitle ) {
                pageReplacements.push( new Array("pageTitle", replacements[i][1]) );
            }
            else if( replacements[i][0] == pageX_XContent ) {
                pageReplacements.push( new Array("pageContent", replacements[i][1]) );
            }
        }
        else {
            pageReplacements.push( replacements[i] );
        }
    }
    // construct the menus and add them in: 
    for( var i=0; i<menus.length; i++ ) {
        var myName = "menu" + i;
        var menuHTML = makeMenu(i, menus[i]);
        pageReplacements.push( new Array(myName, menuHTML) );
    }
    return pageReplacements;
}

function getPage(templateHTML, menu, menuRank, replacements) {
    var pageReps = getPageReplacements(menu, menuRank, replacements);
    alert('pageReps: ' + pageReps);
    return templateToHTML(templateHTML, pageReps);
}

var myReplacements = new Array(
    new Array('page0_0Title', "Home"),
    new Array('page0_0Content', "<h2>This is my first header</h2><p>Lorem!</p>"),
    new Array('page0_1Title', "About"),
    new Array('page0_1Content', "<h2>About us</h2><p>Lorem! Lorem! Lorem!</p>"),
    new Array('page0_2Title', "Contace"),
    new Array('page0_2Content', "<p>If you need to call me, just use the sky-signal</p>"),
    new Array('menu0', 'foo'),
    new Array('websiteTitle', 'My New Website'),
    new Array('footer', 'Copyright March 12 2016 All rights reserved')
);

function getReplacementsFromForm() {
    var myReps = new Array();

    // Get all the relevant input elements
    var myInputs = getElementsByClassName(document, 'userInput');

    for( var i=0; i<myInputs.length; i++ ) {
        myReps.push( new Array( myInputs[i].name, myInputs[i].value ) );
    }
    return myReps;
}

function doPreviewStuff() {

    // AT SOME POINT DO PROCESSING FOR PAGE AND MENU 
    
    var myReps = getReplacementsFromForm();

    var html = getPage(basicTemplate.html, 0, 0, myReps);
    html = "data:text/html;charset=utf-8," + html;
    window.open(html);
}
</script>
</head>

<body>
<h1>Exciting website creator - Create a new website</h1>

<p>Website design template
    <select>
      <option selected="selected"> --- Choose a website design --- </option>
      <option onclick="templateChosen()">Basic Template</option>
      <option onclick="templateChosen()">Basic Template</option>
      <option onclick="templateChosen()">Basic Template</option>
      <option onclick="templateChosen()">You can choose any template you like as long as it's the Basic Template</option>
    </select>
</p>

<div id="dynamic">

</div><!--#dynamic-->

<div id="newPage" style="visibility:hidden;">
    <p><input type='submit' value='Create another page' onclick='createnewpage()'></p>
</div><!--#newPage-->

<div id="newMenu" style="visibility:hidden;">
    <p><input type='submit' value='Create another menu' onclick='createnewmenu()'></p>
</div><!--#newMenu-->

<p><input type="submit" value="View page" onclick="doPreviewStuff()" ></input></p>


</body>
</html>
